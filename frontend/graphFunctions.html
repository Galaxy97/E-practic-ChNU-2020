<script>
  // ------ створити заголовки для таблиці графіків з довідників
  function createHeader() {
    const tr = document.createElement("tr");
    externalData.formData.forEach(unit => {
      if (!unit.display) return false; // якщо елемент не потрібно відображати, пропустити його
      const th = document.createElement("th");
      th.innerText = unit.name;
      tr.append(th);
    });
    return tr;
  }
  //-------------------------------------------------------------

  //-------------- створення кнопки для створення рядку для створення нового графіку
  function createBtnNewGraph() {
    const table = document.getElementById("table");
    const btn = document.createElement("button");
    btn.innerText = "створити новий графік";
    btn.onclick = () => {
      btn.remove();
      table.append(createNewGraph());
    };
    table.append(btn);
  }
  //--------------------------------------------------------

  // ----------- створити рядок для додавання нового графіку
  function createNewGraph() {
    const tr = document.createElement("tr");
    const newRecord = createInputUnits(tr, "create"); // стоворити комірки для введення інформації, та повернути об'єкт як результат, де будуть зберігатись дані з юнітів
    tr.append(createNewGraphButtons(tr, newRecord));
    return tr;
  }
  // -------------------------------------------------------

  //-------------- створення елементів для введення інформації
  function createInputUnits(tr, mode, data) {
    const thisRecord =
      data ||
      (() => {
        const obj = {};
        externalData.formData.forEach(unit => {
          obj[unit.key] = false;
        });
        return obj;
      })();

    externalData.formData.forEach(unit => {
      if (!unit.display) return false;
      const td = document.createElement("td");
      td.onchange = () => {
        thisRecord[unit.key] = td.childNodes[0].value;
      };
      tr.append(td);
      td.append(createInputUnit(mode, unit));
    });
    return thisRecord;
  }
  //--------------------------------------------------------

  //-------------- створення елементу для введення інформації
  function createInputUnit(mode, unit) {
    switch (unit.tag) {
      //  -------------------------------------------------------------   SELECT
      case "select":
        const select = document.createElement("select");
        if (unit.dependency) {
          // якщо є залежність для виведення даних, ствротити пустий опшин та надати id щоб потім знайти цей елемент та наповнити
          select.append(createDefaulteOption());
          select.id = `${mode}-${unit.key}`;
          // ====== special
          if (unit.key === "specialty") {
            const data = sortData(
              externalData.handBook[unit.key],
              userInfo.department_id,
              externalData.objectKeys[unit.key]
            );
            console.log(data);
            for (const key in data) {
              const value = data[key][externalData.objectKeys[unit.key].value];
              const text = data[key][externalData.objectKeys[unit.key].text];
              select.append(createOption(value, text));
            }
          }
          // ====== end special
        } else {
          if (unit.descendant) {
            select.onchange = () => {
              const value = select.options[select.selectedIndex].value;
              const descendant = document.getElementById(`${mode}-${unit.descendant}`);
              descendant.innerHTML = "";
              const data = sortData(
                externalData.handBook[unit.descendant],
                value,
                externalData.objectKeys[unit.descendant]
              );
              // ----------
              descendant.append(createDefaulteOption());
              for (const key in data) {
                const value = data[key][externalData.objectKeys[unit.descendant].value];
                const text = data[key][externalData.objectKeys[unit.descendant].text];
                descendant.append(createOption(value, text));
              }
              //-----------
            };
          }
          // якщо не має жодних залежностей
          select.append(createDefaulteOption());
          for (const key in externalData.handBook[unit.key]) {
            const value = externalData.handBook[unit.key][key][externalData.objectKeys[unit.key].value];
            const text = externalData.handBook[unit.key][key][externalData.objectKeys[unit.key].text];
            select.append(createOption(value, text));
          }
        }
        return select;
        break;
      //  -------------------------------------------------------------  END  SELECT
      case "input":
        const input = document.createElement("input");
        input.type = unit.type;
        return input;
        break;
      case "system":
        return "";
        break;
    }
  }
  //--------------------------------------------------------

  function createOption(value, text) {
    const option = document.createElement("option");
    option.value = value;
    option.text = text;
    return option;
  }
  function createDefaulteOption() {
    const option = document.createElement("option");
    option.setAttribute("selected", null);
    option.setAttribute("disabled", null);
    option.setAttribute("hidden", null);

    option.value = "";
    option.text = "Виберіть дані";
    return option;
  }
  function sortData(sourceData, criterion, setting) {
    const array = [];
    for (const key in sourceData) {
      if (criterion == sourceData[key][setting.parantValue]) {
        array.push(sourceData[key]);
      }
    }
    return array;
  }

  function createNewGraphButtons(tr, thisRecorData) {
    const td = document.createElement("td");
    const saveBtn = document.createElement("button");
    const cancelBtn = document.createElement("button");
    td.append(saveBtn);
    td.append(cancelBtn);

    saveBtn.innerText = "зберегти";
    saveBtn.onclick = () => {
      thisRecorData.user_email = userInfo.user_email;
      thisRecorData.institutes = userInfo.institute_id;
      thisRecorData.departments = userInfo.department_id;

      for (const unit of externalData.formData) {
        if (unit.necessarily) {
          if (!thisRecorData[unit.key]) {
            alert(`Введіть дані ${unit.name}`);
            return;
          }
        }
      }
      // externalData.formData.forEach(unit => {
      //   if (unit.necessarily) {
      //     if (!thisRecorData[unit.key]) {
      //       alert(`Введіть дані ${unit.name}`);
      //       return
      //     }
      //   }
      // })

      tr.remove();
      createBtnNewGraph();
    };

    cancelBtn.innerText = "відмінити";
    cancelBtn.onclick = () => {
      tr.remove();
      createBtnNewGraph();
    };
    return td;
  }
</script>
